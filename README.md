# Hotel Management System - Микросервисная архитектура

Проект управления отелями для бронирования номеров с распределенной архитектурой. 

## Технологический стек

- Java 17
- Spring Boot 3.3.5
- Spring Cloud 2023.0.3
- Spring Data JPA + H2 (in-memory)
- Spring Security + JWT
- Spring Cloud Netflix Eureka
- Spring Cloud Gateway
- OpenFeign (межсервисное взаимодействие)
- Spring Retry (устойчивости)
- Lombok
- JUnit 5 + MockMvc

## Архитектура системы

Система реализована на основе микросервисной архитектуры с разделением ответственности между компонентами.
Каждый сервис является автономным приложением со своей областью данных и бизнес-логикой.

В состав решения входят следующие модули:

**Service Discovery** - централизованный реестр сервисов, обеспечивающий динамическое обнаружение и балансировку

**API Gateway** — единая точка входа в систему, отвечающая за маршрутизацию, фильтрацию и сквозную трассировку запросов

**Hotel Management Service** — управление отелями и номерным фондом

**Booking Service** — управление бронированиями и аутентификацией пользователей

Запуск системы осуществляется в следующей последовательности:
Service Discovery → прикладные сервисы → API Gateway.

В проекте использован swagger, написаны интеграционные тесты, реализована аутентификация пользователей 
через oauth2 resource server.   

Используется H2 - in-memory БД.
Распределение по номерам равномерное, завязывается на количество заселений.

Запросы идемпотентны.

## Алгоритм распределения номеров

Для обеспечения равномерной загрузки номерного фонда используется детерминированный алгоритм рекомендаций.

Каждый номер содержит счётчик бронирований (`timesBooked`), отражающий степень его использования.
При выборе номера система выполняет сортировку по следующим критериям:

1. значение `timesBooked` по возрастанию

2. идентификатор номера (`id`) по возрастанию

При включённом режиме автоматического выбора (`autoSelect = true`) система назначает номер с минимальной текущей нагрузкой.
Подход обеспечивает предсказуемое и равномерное распределение бронирований без применения сложных балансировочных механизмов.

---

## Процесс бронирования (Saga)

Процесс бронирования реализован в виде распределённой саги, обеспечивающей согласованность данных между сервисами без использования распределённых транзакций.

Основные этапы процесса:

1. *PENDING* — создание бронирования в начальном состоянии

2. Confirm availability — запрос подтверждения доступности номера
POST `/api/rooms/{id}/confirm-availability`

3. *CONFIRMED* — успешное завершение процесса бронирования

4. *CANCELLED* — компенсационный сценарий при ошибках:

5. перевод бронирования в статус *CANCELLED*

6. освобождение номера
POST `/api/rooms/{id}/release`

Компенсационные действия выполняются автоматически при возникновении ошибок на любом этапе саги.

---

## Устойчивость и Retry

Для повышения отказоустойчивости межсервисных взаимодействий используются механизмы повторных попыток и таймаутов.

В системе настроены следующие параметры:

- повторные вызовы с использованием @Retryable

- максимальное количество попыток — 3

- экспоненциальный backoff: 500 ms × 2

- таймаут Feign-клиента — 2 секунды

При исчерпании попыток инициируется компенсационный сценарий, предотвращающий возникновение неконсистентных состояний.

---

## Идемпотентность

Все внешние запросы к системе поддерживают идемпотентность.

Каждый запрос содержит уникальный идентификатор requestId.
Повторные запросы с тем же идентификатором корректно распознаются и не приводят к повторному выполнению бизнес-операций.

Механизм позволяет:

- безопасно обрабатывать повторные вызовы

- предотвращать дублирование бронирований

- повышать устойчивость при сетевых сбоях

---

## Трассировка

Для сквозной трассировки запросов используется набор технических идентификаторов:

- API Gateway добавляет заголовок operUid для каждого входящего запроса

- `bookingId` используется как ключ трассировки распределённой саги

Все ключевые этапы бизнес-процессов логируются с указанием идентификаторов, что обеспечивает прозрачность выполнения операций и упрощает анализ инцидентов.

---

## Безопасность

Система использует модель безопасности на основе JWT и паттерна Resource Server.

Основные характеристики:

- срок действия JWT — 1 час

- роли доступа: USER, ADMIN

- контроль доступа на уровне методов с использованием @PreAuthorize

- корректная обработка ошибок авторизации и аутентификации (HTTP 401 / 403)

Решение соответствует актуальным рекомендациям Spring Security и не содержит состояния на стороне сервисов

# Предзаполнение данных 

Есть предзаполнение данных с помощью DataSeeder классов